{{- if or (eq .chezmoi.os "darwin") (eq .chezmoi.os "linux") -}}
#!/bin/bash

# --- macOS (Darwin) Setup ---
setup_darwin() {
    echo ">>> Starting macOS Setup..."
    
    # Install Homebrew if not present
    if ! command -v brew &> /dev/null; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi

    # Run brew bundle
    if [ -f "$HOME/.config/brew/Brewfile" ]; then
        brew bundle --file=~/.config/brew/Brewfile
    else
        echo "Error: Brewfile not found at ~/.config/brew/Brewfile"
    fi
}

# --- Arch Linux Setup (Containerized) ---
setup_arch() {
    echo ">>> Starting Arch Linux Container Setup..."

    # 1. Initialize Keyring (Required for fresh Arch containers)
    pacman-key --init
    pacman-key --populate archlinux

    # 2. Update and Install all tools via pacman
    echo ">>> Installing tools via pacman..."
    pacman -Syu --noconfirm \
        base-devel \
        go \
        python \
        neovim \
        lazygit \
        github-cli \
        fzf \
        ripgrep \
        jq \
        stow \
        tree \
        pv \
        fastfetch \
        dust \
        chezmoi \
        unzip \
        wget \
        curl \
        fontconfig

    # 3. Install fnm (Fast Node Manager)
    if ! command -v fnm &> /dev/null; then
        echo ">>> Installing fnm..."
        curl -fsSL https://fnm.vercel.app/install | bash -s -- --skip-shell --install-dir "/usr/local/bin"
    fi

    # 4. Install fx (JSON viewer) via Go
    if ! command -v fx &> /dev/null; then
        echo ">>> Installing fx..."
        go install github.com/antonmedv/fx@latest
        # Ensure the symlink points to the correct go/bin path in Arch
        ln -sf /root/go/bin/fx /usr/local/bin/fx
    fi

    # 5. Environment Persistence & TrueColor Fix
    # This ensures your terminal environment is ready every time you 'exec'
    {
        echo 'export TERM=xterm-256color'
        echo 'export PATH=$PATH:/usr/local/bin:/root/go/bin'
        echo 'alias vim="nvim"'
    } >> /root/.bashrc

    echo "==========================================="
    echo "  Arch Linux Environment Setup Complete!"
    echo "==========================================="
}

# --- Main Dispatcher ---
setup_environment() {
    case "$OSTYPE" in
        darwin*)
            setup_darwin
            ;;
        linux-gnu*)
            # Check if we are in an Arch Linux environment
            if [ -f /etc/arch-release ]; then
                setup_arch
            else
                echo "Error: Linux detected, but it is not Arch Linux. Setup aborted."
                exit 1
            fi
            ;;
        *)
            echo "Unsupported OS: $OSTYPE"
            exit 1
            ;;
    esac
}

setup_environment
{{- end -}}
